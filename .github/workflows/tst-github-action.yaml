name: Test manual action run
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment under test"
        required: true
        default: "prod"
        type: choice
        options: ["prod"]

jobs:
  matrix-prep:
    name: Print the input
    runs-on: ubuntu-latest
    outputs:
      datacenters: ${{ steps.set-matrix.outputs.datacenters }}
      hostname: ${{ steps.set-matrix.outputs.hostname }}
    steps:
      - name: Fetch env specific params
        id: set-matrix
        run: |
          datacenters=$(echo "${{ secrets.TEST_SECRET_1 }}" | jq '."${{ inputs.environment }}".datacenters')
          hostname=$(echo "${{ secrets.TEST_SECRET_1 }}" | jq '."${{ inputs.environment }}".hostname')
          echo ::set-output name=datacenters::{\"include\":$(echo $datacenters)}
          echo ::set-output name=hostname::$(echo $hostname)
      - name: Print env specific params
        run: |
          echo ${{ steps.set-matrix.outputs.matrix}}
  loop-matrix:
    needs: matrix-prep
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.matrix-prep.outputs.datacenters) }}
    steps:
      - name: print-vals
        run: |
          echo "${{ needs.matrix-prep.outputs.hostname }}"
          echo "${{ datacenters.name }}"
