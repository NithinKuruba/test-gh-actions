name: Build and Deploy

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-20.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v2

      - name: Pull the main branch again
        run: git pull origin main --rebase

      - name: Setup Terraform
        id: tf
        uses: bcgov/sso-requests-actions/actions/setup-terraform@fix-job
        with:
          context: ./terraform-v2
          tf-version: ${{ env.TF_VERSION }}
          tf-s3-bucket: xgr00q-testing-nk
          tf-s3-bucket-key: keycloak/gold
          tf-s3-dynamodb-table: xgr00q-testing-nk
          tf-s3-access-key: ${{ secrets.TF_S3_ACCESS_KEY }}
          tf-s3-secret-key: ${{ secrets.TF_S3_SECRET_KEY }}
          tf-s3-role-arn: ${{ secrets.TF_S3_ROLE_ARN }}
          kc-provider-version: 3.10.0
          kc-dev-url: https://sso-keycloak-c6af30-dev.apps.gold.devops.gov.bc.ca
          kc-test-url: http://example.com
          kc-prod-url: http://example.com
          kc-dev-secret: ${{ secrets.KEYCLOAK_V2_DEV_CLIENT_SECRET }}
          kc-test-secret: abc123
          kc-prod-secret: abc123
          dev-github-client-id: abc123
          dev-github-client-secret: abc123
          test-github-client-id: abc123
          test-github-client-secret: abc123
          prod-github-client-id: abc123
          prod-github-client-secret: abc123gi
          tf-modules-ref: dev
        continue-on-error: true
